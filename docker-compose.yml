services:
  # TimescaleDB for time-series metrics
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: agent_obs_timescaledb
    environment:
      POSTGRES_DB: ${TIMESCALE_DB:-agent_observability}
      POSTGRES_USER: ${TIMESCALE_USER:-postgres}
      POSTGRES_PASSWORD: ${TIMESCALE_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./backend/db/init-timescale.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agent_obs_network

  # PostgreSQL for relational data
  postgres:
    image: postgres:15-alpine
    container_name: agent_obs_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-agent_observability_metadata}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/db/init-postgres.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agent_obs_network

  # Redis for caching, queues, and pub/sub
  redis:
    image: redis:7-alpine
    container_name: agent_obs_redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - agent_obs_network

  # API Gateway (Phase 1)
  gateway:
    build:
      context: ./backend/gateway
      dockerfile: Dockerfile
    container_name: agent_obs_gateway
    environment:
      - TIMESCALE_URL=postgresql://postgres:postgres@timescaledb:5432/agent_observability
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/agent_observability_metadata
      - REDIS_URL=redis://:redis123@redis:6379/0
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      - API_KEY_SALT=${API_KEY_SALT}
      - RATE_LIMIT_REQUESTS_PER_MINUTE=1000
      - RATE_LIMIT_BURST=100
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    ports:
      - "8000:8000"
    depends_on:
      timescaledb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network

  # Ingestion Service (Phase 1)
  ingestion:
    build:
      context: ./backend/ingestion
      dockerfile: Dockerfile
    container_name: agent_obs_ingestion
    environment:
      - REDIS_URL=redis://:redis123@redis:6379/0
    ports:
      - "8001:8001"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network

  # Processing Service (Phase 1)
  processing:
    build:
      context: ./backend/processing
      dockerfile: Dockerfile
    container_name: agent_obs_processing
    environment:
      - TIMESCALE_URL=postgresql://postgres:postgres@timescaledb:5432/agent_observability
      - REDIS_URL=redis://:redis123@redis:6379/0
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network

  # Query Service (Phase 2)
  query:
    build:
      context: ./backend/query
      dockerfile: Dockerfile
    container_name: agent_obs_query
    environment:
      - TIMESCALE_URL=postgresql://postgres:postgres@timescaledb:5432/agent_observability
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/agent_observability_metadata
      - REDIS_URL=redis://:redis123@redis:6379/0
      - CACHE_TTL_HOME_KPIS=300
      - CACHE_TTL_ALERTS=60
      - CACHE_TTL_ACTIVITY=30
      - CACHE_TTL_TRACES=120
      - DEBUG=False
    ports:
      - "8003:8003"
    depends_on:
      timescaledb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Frontend (Phase 2)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: agent_obs_frontend
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    ports:
      - "3000:3000"
    depends_on:
      - gateway
    networks:
      - agent_obs_network
    # Volumes commented out for production build - uncomment for development
    # volumes:
    #   - ./frontend:/app
    #   - /app/node_modules
    #   - /app/.next

  # Evaluation Service (Phase 4)
  evaluation:
    build:
      context: ./backend/evaluation
      dockerfile: Dockerfile
    container_name: agent_obs_evaluation
    environment:
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/agent_observability_metadata
      - REDIS_URL=redis://:redis123@redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PORT=8004
      - CACHE_TTL_EVALUATIONS=300
      - DEBUG=False
    ports:
      - "8004:8004"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Guardrail Service (Phase 4)
  guardrail:
    build:
      context: ./backend/guardrail
      dockerfile: Dockerfile
    container_name: agent_obs_guardrail
    environment:
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/agent_observability_metadata
      - TIMESCALE_URL=postgresql://postgres:postgres@timescaledb:5432/agent_observability
      - REDIS_URL=redis://:redis123@redis:6379/0
      - PORT=8005
      - CACHE_TTL_RULES=600
      - DEBUG=False
    ports:
      - "8005:8005"
    depends_on:
      timescaledb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Alert Service (Phase 4)
  alert:
    build:
      context: ./backend/alert
      dockerfile: Dockerfile
    container_name: agent_obs_alert
    environment:
      - TIMESCALE_URL=postgresql://postgres:postgres@timescaledb:5432/agent_observability
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/agent_observability_metadata
      - REDIS_URL=redis://:redis123@redis:6379/0
      - PORT=8006
      - WEBHOOK_TIMEOUT_SECONDS=10
      - ALERT_CHECK_INTERVAL_SECONDS=60
      - DEBUG=False
    ports:
      - "8006:8006"
    depends_on:
      timescaledb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Gemini Integration Service (Phase 4)
  gemini:
    build:
      context: ./backend/gemini
      dockerfile: Dockerfile
    container_name: agent_obs_gemini
    environment:
      - TIMESCALE_URL=postgresql://postgres:postgres@timescaledb:5432/agent_observability
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/agent_observability_metadata
      - REDIS_URL=redis://:redis123@redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PORT=8007
      - CACHE_TTL_INSIGHTS=1800
      - DEBUG=False
    ports:
      - "8007:8007"
    depends_on:
      timescaledb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agent_obs_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  timescaledb_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  agent_obs_network:
    driver: bridge
